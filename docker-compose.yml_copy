version: '3'
services:
  network:
    image: hivecell/fl-grid-network:production
    build: ./apps/network
    environment:
      - PORT=7000
      - SECRET_KEY=ineedtoputasecrethere
      - DATABASE_URL=sqlite:///databasenetwork.db
    ports:
      - 7000:7000

  alice:
    image: hivecell/fl-grid-node:production
    build: ./apps/node
    devices:
      - "/dev/nvhost-ctrl:/dev/nvhost-ctrl"
      - "/dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu"
      - "/dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu"
      - "/dev/nvmap:/dev/nvmap"
      - "/dev/nvhost-gpu:/dev/nvhost-gpu"
      - "/dev/nvhost-as-gpu:/dev/nvhost-as-gpu"
    environment:
      - NODE_ID=Alice
      - ADDRESS=http://alice:5000/
      - PORT=5000
      - NETWORK=http://network:7000
      - DATABASE_URL=sqlite:///databasenode.db
      - LD_LIBRARY_PATH=/usr/local/cuda-10.2/targets/aarch64-linux/lib
    depends_on:
      - 'network'
    ports:
      - 5000:5000
    volumes:
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib:/usr/local/cuda-10.2/targets/aarch64-linux/lib
      - /usr/lib/aarch64-linux-gnu/libcublas.so.10:/usr/lib/aarch64-linux-gnu/libcublas.so.10
      - /usr/lib/aarch64-linux-gnu/libcublas.so:/usr/lib/aarch64-linux-gnu/libcublas.so
      - /usr/lib/aarch64-linux-gnu/libopenblas.so.0:/usr/lib/aarch64-linux-gnu/libopenblas.so.0
      - /usr/lib/aarch64-linux-gnu/libcublasLt.so.10:/usr/lib/aarch64-linux-gnu/libcublasLt.so.10
      - /usr/lib/aarch64-linux-gnu/libgfortran.so.4:/usr/lib/aarch64-linux-gnu/libgfortran.so.4
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so

  bob:
    image: hivecell/fl-grid-node:production
    build: ./apps/node
    devices:
      - "/dev/nvhost-ctrl:/dev/nvhost-ctrl"
      - "/dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu"
      - "/dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu"
      - "/dev/nvmap:/dev/nvmap"
      - "/dev/nvhost-gpu:/dev/nvhost-gpu"
      - "/dev/nvhost-as-gpu:/dev/nvhost-as-gpu"
    environment:
      - NODE_ID=Bob
      - ADDRESS=http://bob:5001/
      - PORT=5001
      - NETWORK=http://network:7000
      - DATABASE_URL=sqlite:///databasenode.db
      - LD_LIBRARY_PATH=/usr/local/cuda-10.2/targets/aarch64-linux/lib
    depends_on:
      - 'network'
    ports:
      - 5001:5001
    volumes:
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib:/usr/local/cuda-10.2/targets/aarch64-linux/lib
      - /usr/lib/aarch64-linux-gnu/libcublas.so.10:/usr/lib/aarch64-linux-gnu/libcublas.so.10
      - /usr/lib/aarch64-linux-gnu/libcublas.so:/usr/lib/aarch64-linux-gnu/libcublas.so
      - /usr/lib/aarch64-linux-gnu/libopenblas.so.0:/usr/lib/aarch64-linux-gnu/libopenblas.so.0
      - /usr/lib/aarch64-linux-gnu/libcublasLt.so.10:/usr/lib/aarch64-linux-gnu/libcublasLt.so.10
      - /usr/lib/aarch64-linux-gnu/libgfortran.so.4:/usr/lib/aarch64-linux-gnu/libgfortran.so.4
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so

  charlie:
    image: hivecell/fl-grid-node:production
    build: ./apps/node
    devices:
      - "/dev/nvhost-ctrl:/dev/nvhost-ctrl"
      - "/dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu"
      - "/dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu"
      - "/dev/nvmap:/dev/nvmap"
      - "/dev/nvhost-gpu:/dev/nvhost-gpu"
      - "/dev/nvhost-as-gpu:/dev/nvhost-as-gpu"
    environment:
      - NODE_ID=Charlie
      - ADDRESS=http://charlie:5002/
      - PORT=5002
      - NETWORK=http://network:7000
      - DATABASE_URL=sqlite:///databasenode.db
      - LD_LIBRARY_PATH=/usr/local/cuda-10.2/targets/aarch64-linux/lib
    depends_on:
      - 'network'
    ports:
      - 5002:5002
    volumes:
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib:/usr/local/cuda-10.2/targets/aarch64-linux/lib
      - /usr/lib/aarch64-linux-gnu/libcublas.so.10:/usr/lib/aarch64-linux-gnu/libcublas.so.10
      - /usr/lib/aarch64-linux-gnu/libcublas.so:/usr/lib/aarch64-linux-gnu/libcublas.so
      - /usr/lib/aarch64-linux-gnu/libopenblas.so.0:/usr/lib/aarch64-linux-gnu/libopenblas.so.0
      - /usr/lib/aarch64-linux-gnu/libcublasLt.so.10:/usr/lib/aarch64-linux-gnu/libcublasLt.so.10
      - /usr/lib/aarch64-linux-gnu/libgfortran.so.4:/usr/lib/aarch64-linux-gnu/libgfortran.so.4
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so

  dan:
    image: hivecell/fl-grid-node:production
    build: ./apps/node
    devices:
      - "/dev/nvhost-ctrl:/dev/nvhost-ctrl"
      - "/dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu"
      - "/dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu"
      - "/dev/nvmap:/dev/nvmap"
      - "/dev/nvhost-gpu:/dev/nvhost-gpu"
      - "/dev/nvhost-as-gpu:/dev/nvhost-as-gpu"
    environment:
      - NODE_ID=Dan
      - ADDRESS=http://dan:5003/
      - PORT=5003
      - NETWORK=http://network:7000
      - DATABASE_URL=sqlite:///databasenode.db
      - LD_LIBRARY_PATH=/usr/local/cuda-10.2/targets/aarch64-linux/lib
    depends_on:
      - 'network'
    ports:
      - 5003:5003
    volumes:
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib:/usr/local/cuda-10.2/targets/aarch64-linux/lib
      - /usr/lib/aarch64-linux-gnu/libcublas.so.10:/usr/lib/aarch64-linux-gnu/libcublas.so.10
      - /usr/lib/aarch64-linux-gnu/libcublas.so:/usr/lib/aarch64-linux-gnu/libcublas.so
      - /usr/lib/aarch64-linux-gnu/libopenblas.so.0:/usr/lib/aarch64-linux-gnu/libopenblas.so.0
      - /usr/lib/aarch64-linux-gnu/libcublasLt.so.10:/usr/lib/aarch64-linux-gnu/libcublasLt.so.10
      - /usr/lib/aarch64-linux-gnu/libgfortran.so.4:/usr/lib/aarch64-linux-gnu/libgfortran.so.4
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so

  jupyter:
    image: hivecell/fl-notebook:production  # syft 0.2.9
    build: ./apps/notebook'
    devices:
      - "/dev/nvhost-ctrl:/dev/nvhost-ctrl"
      - "/dev/nvhost-ctrl-gpu:/dev/nvhost-ctrl-gpu"
      - "/dev/nvhost-prof-gpu:/dev/nvhost-prof-gpu"
      - "/dev/nvmap:/dev/nvmap"
      - "/dev/nvhost-gpu:/dev/nvhost-gpu"
      - "/dev/nvhost-as-gpu:/dev/nvhost-as-gpu"
    environment:
      - LD_LIBRARY_PATH=/usr/local/cuda-10.2/targets/aarch64-linux/lib
    ports:
      - 8888:8888
    volumes:
      - ./examples:/workspace/examples
      - /usr/lib/aarch64-linux-gnu/tegra:/usr/lib/aarch64-linux-gnu/tegra
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib:/usr/local/cuda-10.2/targets/aarch64-linux/lib
      - /usr/lib/aarch64-linux-gnu/libcublas.so.10:/usr/lib/aarch64-linux-gnu/libcublas.so.10
      - /usr/lib/aarch64-linux-gnu/libcublas.so:/usr/lib/aarch64-linux-gnu/libcublas.so
      - /usr/lib/aarch64-linux-gnu/libopenblas.so.0:/usr/lib/aarch64-linux-gnu/libopenblas.so.0
      - /usr/lib/aarch64-linux-gnu/libcublasLt.so.10:/usr/lib/aarch64-linux-gnu/libcublasLt.so.10
      - /usr/lib/aarch64-linux-gnu/libgfortran.so.4:/usr/lib/aarch64-linux-gnu/libgfortran.so.4
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so.1.0.0
      - /usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so:/usr/local/cuda-10.2/targets/aarch64-linux/lib/libnvToolsExt.so
